<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dream Journal</title>

<!-- iOS Safari Add to Home Screen -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Dream Journal">

<!-- Link manifest -->
<link rel="manifest" href="manifest.json">

<!-- Emoji icon -->
<link id="apple-touch-icon" rel="apple-touch-icon" href="">

<style>
  body {
    font-family: "Segoe UI", Roboto, sans-serif;
    background-color: #121212;
    color: #eee;
    margin: 0;
    padding: 0;
  }
  header { padding: 1rem; text-align: center; background: #1e1e1e; box-shadow: 0 2px 5px rgba(0,0,0,0.6); }
  header h1 { margin: 0; font-size: 1.5rem; color: #00c6ff; }
  main { padding: 1rem; max-width: 700px; margin: auto; transition: filter 0.3s ease; }
  .blurred { filter: blur(5px); }
  .controls { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
  input[type="text"], select, textarea { flex: 1; padding: 0.6rem; border-radius: 8px; border: none; background: #2a2a2a; color: #eee; font-size: 1rem; resize: none; }
  select { flex: unset; }
  .card { background: #1e1e1e; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.7); cursor: pointer; transition: background 0.2s; }
  .card:hover { background: #242424; }
  .card h3 { margin: 0; font-size: 1rem; color: #00c6ff; }
  .tags { margin-top: 0.5rem; }
  .tag { display: inline-block; background: #333; color: #00c6ff; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; margin-right: 0.3rem; }
  #addBtn, #settingsBtn, #importExportBtn {
    position: fixed;
    background: linear-gradient(45deg, #00c6ff, #0072ff);
    border: none; border-radius: 50%; font-size: 1.5rem; color: white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 101;
  }
  #addBtn { bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 2rem; }
  #settingsBtn { top: 20px; right: 20px; width: 50px; height: 50px; }
  #importExportBtn { top: 20px; left: 20px; width: 50px; height: 50px; }
  .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; z-index: 200; }
  .modal.active { display: flex; }
  .modalContent { background: #1e1e1e; padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 6px 20px rgba(0,0,0,0.8); display: flex; flex-direction: column; gap: 0.5rem; text-align: center; }
  button { padding: 0.8rem; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; width: 100%; margin-top: 0.5rem; }
  button.action { background: linear-gradient(45deg, #00c6ff, #0072ff); color: #fff; }
  button.delete { background: #ff4b4b; color: #fff; }
  button.cancel { background: #555; color: #fff; }
</style>
</head>
<body>

<header>
  <h1>üåô Dream Journal</h1>
</header>

<button id="importExportBtn">‚áÖ</button>
<button id="settingsBtn">‚öôÔ∏è</button>

<main id="mainContent">
  <div class="controls">
    <input type="text" id="searchInput" placeholder="Search dreams...">
    <select id="tagFilter"><option value="">Filter by tag</option></select>
    <select id="sortSelect">
      <option value="newest">Newest First</option>
      <option value="oldest">Oldest First</option>
      <option value="longest">Longest</option>
      <option value="shortest">Shortest</option>
    </select>
  </div>
  <div id="entries"></div>
</main>

<button id="addBtn">+</button>

<!-- Modals (Add/Edit/Delete/Settings/Import) -->
<div class="modal" id="dreamModal">
  <div class="modalContent">
    <h2 id="modalTitle">Add Dream</h2>
    <input type="text" id="dreamName" placeholder="Dream Name">
    <textarea id="dreamText" rows="8" placeholder="Write your dream..."></textarea>
    <input type="text" id="dreamTags" placeholder="Tags (comma separated)">
    <button class="action" id="saveDreamBtn">Save</button>
    <button class="cancel" id="cancelDreamBtn">Cancel</button>
  </div>
</div>
<div class="modal" id="deleteModal">
  <div class="modalContent">
    <p>Are you sure you want to delete this dream?</p>
    <button class="delete" id="confirmDeleteBtn">Delete</button>
    <button class="cancel" id="cancelDeleteBtn">Cancel</button>
  </div>
</div>
<div class="modal" id="settingsModal">
  <div class="modalContent">
    <h2>Settings</h2>
    <button class="delete" id="deleteAllBtn">Delete All Dreams</button>
    <button class="action" id="removeDuplicatesBtn">Remove Duplicates</button>
    <button class="cancel" id="cancelSettingsBtn">Close</button>
  </div>
</div>
<div class="modal" id="importExportModal">
  <div class="modalContent">
    <h2>Import / Export</h2>
    <input type="file" id="importFile" accept=".csv,.zip">
    <button class="action" id="exportBtn">Export Dreams (CSV)</button>
    <button class="cancel" id="cancelImportExportBtn">Close</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
/* ---------- Emoji icon generation ---------- */
function createEmojiIcon(emoji="üõèÔ∏è", size=192){
  const canvas = document.createElement("canvas");
  canvas.width = canvas.height = size;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#00c6ff";
  ctx.fillRect(0,0,size,size);
  ctx.font = `${size*0.7}px sans-serif`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillStyle = "#fff";
  ctx.fillText(emoji, size/2, size/2);
  document.getElementById("apple-touch-icon").href = canvas.toDataURL("image/png");
}
createEmojiIcon();

/* ---------- Service Worker Registration ---------- */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}

/* ---------- Dream Journal Logic ---------- */
let dreams = JSON.parse(localStorage.getItem("dreams")) || [];
let deleteIndex = null;
let editIndex = null;

function openModal(id){ document.getElementById(id).classList.add("active"); document.getElementById("mainContent").classList.add("blurred"); }
function closeModal(id){ document.getElementById(id).classList.remove("active"); document.getElementById("mainContent").classList.remove("blurred"); if(id==="dreamModal") resetDreamForm(); }
function resetDreamForm(){ document.getElementById("dreamName").value=""; document.getElementById("dreamText").value=""; document.getElementById("dreamTags").value=""; editIndex=null; document.getElementById("modalTitle").textContent="Add Dream"; }

function saveDream(){
  const name = document.getElementById("dreamName").value.trim();
  const text = document.getElementById("dreamText").value.trim();
  const tagsArr = (document.getElementById("dreamTags").value||"").split(",").map(t=>t.trim()).filter(Boolean);
  if(!name||!text) return alert("Name and dream text required!");
  const nowFormatted = new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
  if(editIndex!==null){ dreams[editIndex]={name,text,tags:tagsArr,date:dreams[editIndex].date||nowFormatted}; }
  else{ dreams.unshift({name,text,tags:tagsArr,date:nowFormatted}); }
  localStorage.setItem("dreams",JSON.stringify(dreams));
  closeModal("dreamModal"); renderDreams();
}

function renderDreams(){
  const entries=document.getElementById("entries"); entries.innerHTML="";
  const search=(document.getElementById("searchInput").value||"").toLowerCase();
  const tagFilter=document.getElementById("tagFilter").value;
  const sortBy=document.getElementById("sortSelect").value;
  const filtered=dreams.map((d,i)=>({d,origIndex:i})).filter(item=>{
    const txt=[item.d.name,item.d.text].join(" ").toLowerCase();
    if(search&&!txt.includes(search)) return false;
    if(tagFilter&&!item.d.tags.includes(tagFilter)) return false;
    return true;
  });

  filtered.sort((a,b)=>{
    switch(sortBy){
      case "newest": return new Date(b.d.date)-new Date(a.d.date);
      case "oldest": return new Date(a.d.date)-new Date(b.d.date);
      case "longest": return (b.d.text.length||0)-(a.d.text.length||0);
      case "shortest": return (a.d.text.length||0)-(b.d.text.length||0);
      default: return 0;
    }
  });

  filtered.forEach(item=>{
    const d=item.d, origIndex=item.origIndex;
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<h3>${d.date} ‚Äî ${d.name}</h3><div class="tags">${(d.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("")}</div><div class="details" style="display:none;"><p>${(d.text||"").replace(/\n/g,"<br>")}</p><button class="action edit">Edit</button><button class="delete">Delete</button></div>`;
    card.onclick=e=>{
      const details=card.querySelector(".details");
      if(e.target.classList.contains("delete")){ deleteIndex=origIndex; openModal("deleteModal"); e.stopPropagation(); }
      else if(e.target.classList.contains("edit")){ editIndex=origIndex; document.getElementById("dreamName").value=d.name; document.getElementById("dreamText").value=d.text; document.getElementById("dreamTags").value=(d.tags||[]).join(", "); document.getElementById("modalTitle").textContent="Edit Dream"; openModal("dreamModal"); e.stopPropagation(); }
      else{ details.style.display=details.style.display==="block"?"none":"block"; }
    };
    entries.appendChild(card);
  });

  const tagSelect=document.getElementById("tagFilter"); tagSelect.innerHTML='<option value="">Filter by tag</option>'; 
  const allTags=new Set(dreams.flatMap(d=>d.tags||[])); Array.from(allTags).sort().forEach(t=>{const o=document.createElement("option"); o.value=t; o.textContent=t; tagSelect.appendChild(o);});
}

/* ---------- Event Bindings ---------- */
document.getElementById("addBtn").onclick=()=>openModal("dreamModal");
document.getElementById("saveDreamBtn").onclick=saveDream;
document.getElementById("cancelDreamBtn").onclick=()=>closeModal("dreamModal");
document.getElementById("confirmDeleteBtn").onclick=()=>{
  if(deleteIndex!==null){ dreams.splice(deleteIndex,1); localStorage.setItem("dreams",JSON.stringify(dreams)); deleteIndex=null; renderDreams(); }
  closeModal("deleteModal");
};
document.getElementById("cancelDeleteBtn").onclick=()=>closeModal("deleteModal");
document.getElementById("searchInput").oninput=renderDreams;
document.getElementById("tagFilter").onchange=renderDreams;
document.getElementById("sortSelect").onchange=renderDreams;
document.getElementById("settingsBtn").onclick=()=>openModal("settingsModal");
document.getElementById("cancelSettingsBtn").onclick=()=>closeModal("settingsModal");
document.getElementById("deleteAllBtn").onclick=()=>{
  if(confirm("Delete ALL dreams?")){ dreams=[]; localStorage.setItem("dreams",JSON.stringify(dreams)); renderDreams(); closeModal("settingsModal"); }
};
document.getElementById("removeDuplicatesBtn").onclick=()=>{
  if(!confirm("Remove duplicate dreams by date?")) return;
  const seen=new Set(); dreams=dreams.filter(d=>{if(!d.date||!seen.has(d.date)){ if(d.date) seen.add(d.date); return true; } return false; }); localStorage.setItem("dreams",JSON.stringify(dreams)); renderDreams(); alert("Duplicates removed."); };
document.getElementById("importExportBtn").onclick=()=>openModal("importExportModal");
document.getElementById("cancelImportExportBtn").onclick=()=>closeModal("importExportModal");

/* ---------- Initial render ---------- */
renderDreams();
</script>
</body>
</html>
