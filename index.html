<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dream Journal</title>
<style>
  body {
    font-family: "Segoe UI", Roboto, sans-serif;
    background-color: #121212;
    color: #eee;
    margin: 0;
    padding: 0;
  }

  header {
    padding: 1rem;
    text-align: center;
    background: #1e1e1e;
    box-shadow: 0 2px 5px rgba(0,0,0,0.6);
  }

  header h1 {
    margin: 0;
    font-size: 1.5rem;
    color: #00c6ff;
  }

  main {
    padding: 1rem;
    max-width: 700px;
    margin: auto;
    transition: filter 0.3s ease;
  }

  .blurred { filter: blur(5px); }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  input[type="text"], select, textarea {
    flex: 1;
    padding: 0.6rem;
    border-radius: 8px;
    border: none;
    background: #2a2a2a;
    color: #eee;
    font-size: 1rem;
    resize: none;
  }

  select { flex: unset; }

  .card {
    background: #1e1e1e;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.7);
    cursor: pointer;
    transition: background 0.2s;
  }

  .card:hover { background: #242424; }

  .card h3 { margin: 0; font-size: 1rem; color: #00c6ff; }

  .tags { margin-top: 0.5rem; }
  .tag {
    display: inline-block;
    background: #333;
    color: #00c6ff;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
    margin-right: 0.3rem;
  }

  #addBtn, #settingsBtn, #importExportBtn {
    position: fixed;
    background: linear-gradient(45deg, #00c6ff, #0072ff);
    border: none;
    border-radius: 50%;
    font-size: 1.5rem;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    z-index: 101;
  }

  #addBtn { bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 2rem; }
  #settingsBtn { top: 20px; right: 20px; width: 50px; height: 50px; }
  #importExportBtn { top: 20px; left: 20px; width: 50px; height: 50px; }

  /* Modal */
  .modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }

  .modal.active { display: flex; }

  .modalContent {
    background: #1e1e1e;
    padding: 1.5rem;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    text-align: center;
  }

  button {
    padding: 0.8rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    width: 100%;
    margin-top: 0.5rem;
  }

  button.action { background: linear-gradient(45deg, #00c6ff, #0072ff); color: #fff; }
  button.delete { background: #ff4b4b; color: #fff; }
  button.cancel { background: #555; color: #fff; }

  /* Message */
  #message {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #00c6ff;
    color: #000;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    display: none;
    z-index: 300;
    font-weight: bold;
  }
</style>
</head>
<body>
<div id="message"></div>
<!-- Bulk Import/Export Modal -->
<div class="modal" id="bulkModal">
  <div class="modalContent">
    <h2>Bulk Import / Export</h2>
    <button class="action" id="exportAllBtn">Export All Dreams</button>
    <textarea id="importTextArea" rows="8" placeholder="Paste your dreams JSON here..."></textarea>
    <button class="action" id="importAllBtn">Import Dreams</button>
    <button class="cancel" id="cancelBulkBtn">Close</button>
  </div>
</div>

<header>
  <h1>üåô Dream Journal</h1>
</header>

<button id="importExportBtn">‚áÖ</button>
<button id="settingsBtn">‚öôÔ∏è</button>

<main id="mainContent">
  <div class="controls">
    <input type="text" id="searchInput" placeholder="Search dreams...">
    <select id="tagFilter"><option value="">Filter by tag</option></select>
    <select id="sortSelect">
      <option value="newest">Newest First</option>
      <option value="oldest">Oldest First</option>
      <option value="longest">Longest</option>
      <option value="shortest">Shortest</option>
    </select>
  </div>
  <div id="entries"></div>
</main>

<button id="addBtn">+</button>

<!-- Add/Edit Dream Modal -->
<div class="modal" id="dreamModal">
  <div class="modalContent">
    <h2 id="modalTitle">Add Dream</h2>
    <input type="text" id="dreamName" placeholder="Dream Name">
    <textarea id="dreamText" rows="8" placeholder="Write your dream..."></textarea>
    <input type="text" id="dreamTags" placeholder="Tags (comma separated)">
    <button class="action" id="saveDreamBtn">Save</button>
    <button class="cancel" id="cancelDreamBtn">Cancel</button>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
  <div class="modalContent">
    <p>Are you sure you want to delete this dream?</p>
    <button class="delete" id="confirmDeleteBtn">Delete</button>
    <button class="cancel" id="cancelDeleteBtn">Cancel</button>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
  <div class="modalContent">
    <h2>Settings</h2>
    <button class="delete" id="deleteAllBtn">Delete All Dreams</button>
    <button class="action" id="removeDuplicatesBtn">Remove Duplicates</button>
    <button class="cancel" id="cancelSettingsBtn">Close</button>
  </div>
</div>

<!-- Import/Export Modal -->
<div class="modal" id="importExportModal">
  <div class="modalContent">
    <h2>Import / Export</h2>
    <input type="file" id="importFile" accept=".csv,.zip">
    <button class="action" id="exportBtn">Export Dreams (CSV)</button>
    <button class="cancel" id="cancelImportExportBtn">Close</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
function showMessage(msg){
  const el=document.getElementById("message");
  el.textContent=msg;
  el.style.display="block";
  setTimeout(()=>{el.style.display="none";},1000);
}

// Add openModal and closeModal to resolve ReferenceError
function openModal(modalId){
  const modal = document.getElementById(modalId);
  if(modal){
    modal.classList.add('active');
    const mainContent = document.getElementById('mainContent');
    if(mainContent) mainContent.classList.add('blurred');
  }
}

function closeModal(modalId){
  const modal = document.getElementById(modalId);
  if(modal){
    modal.classList.remove('active');
    const mainContent = document.getElementById('mainContent');
    if(mainContent) mainContent.classList.remove('blurred');
  }
}

let dreams = JSON.parse(localStorage.getItem("dreams")) || [];
let deleteIndex = null; 
let editIndex = null;   
document.getElementById("exportAllBtn").onclick = async () => {
  try {
    const dataStr = JSON.stringify(dreams);
    await navigator.clipboard.writeText(dataStr);
    showMessage("All dreams copied to clipboard!");
  } catch(err) {
    showMessage("Failed to copy dreams: " + err);
  }
};
document.getElementById("importAllBtn").onclick = () => {
  const dataStr = document.getElementById("importTextArea").value;
  try {
    const imported = JSON.parse(dataStr);
    if (!Array.isArray(imported)) throw "Invalid format";
    dreams = imported;
    localStorage.setItem("dreams", JSON.stringify(dreams));
    renderDreams();
    closeModal("bulkModal");
    showMessage("Dreams imported successfully!");
  } catch(err) {
    showMessage("Failed to import dreams: " + err);
  }
};

document.getElementById("cancelBulkBtn").onclick = () => closeModal("bulkModal");

// Create a floating button to open bulk modal
const bulkBtn = document.createElement("button");
bulkBtn.textContent = "üì¶";
bulkBtn.title = "Bulk Import/Export";
bulkBtn.style.position = "fixed";
bulkBtn.style.bottom = "20px";
bulkBtn.style.left = "20px";
bulkBtn.style.zIndex = "101";
bulkBtn.style.background = "linear-gradient(45deg,#00c6ff,#0072ff)";
bulkBtn.style.border = "none";
bulkBtn.style.borderRadius = "50%";
bulkBtn.style.width = "60px";
bulkBtn.style.height = "60px";
bulkBtn.style.color = "#fff";
bulkBtn.style.fontSize = "2rem";
bulkBtn.style.cursor = "pointer";
bulkBtn.onclick = () => openModal("bulkModal");
document.body.appendChild(bulkBtn);

// (rest of JS unchanged except replacing alert() with showMessage())

/* ---------- Robust CSV Parser ---------- */
function parseCSV(text) { /* unchanged */ }

/* ---------- Auto-detect Import ---------- */
document.getElementById("importFile").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;

  if(file.name.toLowerCase().endsWith(".csv")){
    const reader = new FileReader();
    reader.onload = function(ev){
      const rows = parseCSV(String(ev.target.result || ""));
      if (!rows.length) { showMessage("CSV appears empty."); return; }
      const normalize = s => String(s || "").replace(/^\uFEFF/,"").trim().toLowerCase();
      const header = rows[0].map(h => normalize(h));
      const idx = {
        date: header.indexOf("date"),
        title: header.indexOf("title"),
        story: header.indexOf("story") >= 0 ? header.indexOf("story") : header.indexOf("dream"),
        control: header.indexOf("can control")
      };
      if (idx.date === -1 || idx.title === -1 || idx.story === -1) { showMessage("CSV missing required columns."); return; }
      for (let r = 1; r < rows.length; r++) { /* unchanged body */ }
      localStorage.setItem("dreams", JSON.stringify(dreams));
      renderDreams();
      showMessage("Oniri CSV dreams imported!");
    };
    reader.readAsText(file);
  } else if(file.name.toLowerCase().endsWith(".zip")){
    const reader = new FileReader();
    reader.onload = async function(ev){
      try {
        // unchanged zip logic
        localStorage.setItem("dreams", JSON.stringify(dreams));
        renderDreams();
        showMessage(`Apple Journal: imported ${imported} entries.`);
      } catch (err) {
        console.error(err);
        showMessage("Failed to import Apple Journal ZIP.");
      }
    };
    reader.readAsArrayBuffer(file);
  } else {
    showMessage("Unsupported file type.");
  }
});

/* ---------- Export ---------- */
document.getElementById("exportBtn").addEventListener("click",function(){
  // unchanged CSV export
  showMessage("Dreams exported as CSV!");
});

/* ---------- Settings ---------- */
document.getElementById("removeDuplicatesBtn").onclick = () => {
  if(!confirm("Remove duplicate dreams that share the same date? This will keep only the first occurrence for each date.")) return;
  // unchanged dedupe logic
  showMessage("Duplicates removed (by date).");
};

/* rest of JS unchanged */
</script>
</body>
</html>
